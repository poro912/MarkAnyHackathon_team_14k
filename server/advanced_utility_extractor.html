<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ê³ ê¸‰ ìœ í‹¸ë¦¬í‹° ì¶”ì¶œ ë„êµ¬</title>
    <style>
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        
        .download-btn:hover {
            background: #0056b3 !important;
        }
        
        .upload-btn:hover {
            background: #218838 !important;
        }
        
        .folder-btn:hover {
            background: #e0a800 !important;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active:hover {
            background: #007bff;
        }
        
        /* ë¹Œë“œ íˆìŠ¤í† ë¦¬ ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
        button[onclick*="downloadDLLFromHistory"]:hover {
            background: #218838 !important;
        }
        
        button[onclick*="downloadHeaderFromHistory"]:hover {
            background: #138496 !important;
        }
        
        button[onclick*="generateDocsFromHistory"]:hover {
            background: #e0a800 !important;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            border-bottom-color: #007bff;
            color: #007bff;
            font-weight: bold;
        }
        .tab-content {
            display: none;
            padding: 30px;
        }
        .tab-content.active {
            display: block;
        }
        .upload-section {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #fafafa;
            transition: border-color 0.3s;
        }
        .upload-section.dragover {
            border-color: #007bff;
            background: #f0f8ff;
        }
        .upload-btn, .folder-btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        .folder-btn {
            background: #28a745;
        }
        .utility-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .utility-header {
            padding: 15px 20px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }
        .utility-header:hover {
            background: #e9ecef;
        }
        .utility-details {
            display: none;
            padding: 20px;
            border-top: 1px solid #ddd;
        }
        .utility-role {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-style: italic;
            color: #555;
        }
        .utility-source {
            position: relative;
            background: #f8f8f8;
            border-radius: 4px;
            padding: 15px;
        }
        .copy-btn {
            padding: 5px 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .copy-btn:hover {
            background: #0056b3;
        }
        .build-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .build-btn {
            padding: 12px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .build-result {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
        }
        .download-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        .progress-section {
            display: none;
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('extract')">ìœ í‹¸ë¦¬í‹° ì¶”ì¶œ</button>
            <button class="tab" onclick="showTab('extraction-history')">ì¶”ì¶œ íˆìŠ¤í† ë¦¬</button>
            <button class="tab" onclick="showTab('history')">ë¹Œë“œ íˆìŠ¤í† ë¦¬</button>
        </div>

        <div id="extract" class="tab-content active">
            <div class="upload-section" id="uploadSection">
                <h3>ì†ŒìŠ¤ì½”ë“œ ì—…ë¡œë“œ</h3>
                <p>íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ë†“ê±°ë‚˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                <input type="file" id="fileInput" multiple accept=".cs,.cpp,.c,.h,.py" style="display: none;">
                <input type="file" id="folderInput" webkitdirectory style="display: none;">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">íŒŒì¼ ì„ íƒ</button>
                <button class="folder-btn" onclick="showDirectCodeInput()">ì½”ë“œ ì§ì ‘ì…ë ¥</button>
            </div>

            <div id="utilitiesSection" style="display: none;">
                <h3>ì¶”ì¶œëœ ìœ í‹¸ë¦¬í‹°</h3>
                <div id="utilitiesList"></div>

                <div class="build-config">
                    <div class="config-group">
                        <label>ì•„í‚¤í…ì²˜</label>
                        <select id="architecture">
                            <option value="x64">x64</option>
                            <option value="x86">x86</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <label>ëŸ°íƒ€ì„</label>
                        <select id="runtime">
                            <option value="MD">MD</option>
                            <option value="MT">MT</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <label>MSVC ë²„ì „</label>
                        <select id="msvcVersion">
                            <option value="2022">2022</option>
                            <option value="2019">2019</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <label>ë¼ì´ë¸ŒëŸ¬ë¦¬ íƒ€ì…</label>
                        <select id="libraryType">
                            <option value="dll">DLL (ë™ì  ë¼ì´ë¸ŒëŸ¬ë¦¬)</option>
                            <option value="lib">LIB (ì •ì  ë¼ì´ë¸ŒëŸ¬ë¦¬)</option>
                        </select>
                    </div>
                </div>

                <button class="build-btn" onclick="startBuild()">ë¹Œë“œ ì‹œì‘</button>

                <div class="progress-section" id="progressSection">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div id="progressText">ë¹Œë“œ ì¤€ë¹„ ì¤‘...</div>
                </div>

                <div class="build-result" id="buildResult">
                    <h4>ë¹Œë“œ ì™„ë£Œ!</h4>
                    <p id="buildResultMessage">ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ê³¼ ì‚¬ìš©ë²• ë¬¸ì„œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    <button class="download-btn" id="downloadLibBtn" onclick="downloadLibrary()">ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="download-btn" onclick="downloadHeader()" style="background: #17a2b8;">í—¤ë” ë‹¤ìš´ë¡œë“œ</button>
                    <button class="download-btn" onclick="generateDocs()" id="docsBtn">ê°€ì´ë“œ ë¬¸ì„œ</button>
                    <div id="docsProgress" style="display: none; margin-top: 10px;">
                        <div style="background: #f0f0f0; border-radius: 10px; padding: 3px;">
                            <div id="docsProgressBar" style="background: #28a745; height: 20px; border-radius: 8px; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <p id="docsProgressText">ë¬¸ì„œ ìƒì„± ì¤‘... 0%</p>
                    </div>
                    <div style="margin-top: 15px;">
                        <label>ë¹Œë“œ ì½”ë©˜íŠ¸:</label>
                        <input type="text" id="buildComment" placeholder="ë¹Œë“œì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 300px; margin-left: 10px;">
                        <button class="download-btn" onclick="uploadToHistory()">íˆìŠ¤í† ë¦¬ì— ì—…ë¡œë“œ</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="extraction-history" class="tab-content">
            <h3>ì¶”ì¶œ íˆìŠ¤í† ë¦¬</h3>
            <div style="margin-bottom: 20px;">
                <input type="text" id="searchInput" placeholder="í•¨ìˆ˜ëª…, ì„¤ëª…, ì½”ë“œë¡œ ê²€ìƒ‰..." 
                       style="width: 300px; padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="searchFunctions()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px;">ê²€ìƒ‰</button>
                <button onclick="loadExtractionHistory()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; margin-left: 10px;">ìƒˆë¡œê³ ì¹¨</button>
                <button id="useSelectedBtn" onclick="useSelectedFunctions()" disabled 
                        style="padding: 8px 16px; background: #ffc107; color: black; border: none; border-radius: 4px; margin-left: 10px;">ì„ íƒëœ í•¨ìˆ˜ ì‚¬ìš©</button>
            </div>
            <div id="extractionHistoryList">íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <div id="history" class="tab-content">
            <h3>ë¹Œë“œ íˆìŠ¤í† ë¦¬</h3>
            <button onclick="loadHistory()" style="margin-bottom: 20px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px;">ìƒˆë¡œê³ ì¹¨</button>
            <div id="historyList">íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <script>
        let selectedUtilities = new Set();
        let currentBuildId = null;

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
        const uploadSection = document.getElementById('uploadSection');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            processFiles(files);
        });

        // íŒŒì¼ ì…ë ¥ ì´ë²¤íŠ¸
        document.getElementById('fileInput').addEventListener('change', (e) => {
            processFiles(Array.from(e.target.files));
        });

        document.getElementById('folderInput').addEventListener('change', (e) => {
            processFiles(Array.from(e.target.files));
        });

        function showDirectCodeInput() {
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.innerHTML = `
                <h3>ì½”ë“œ ì§ì ‘ ì…ë ¥</h3>
                <textarea id="codeInput" placeholder="C++ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                          style="width: 100%; height: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;"></textarea>
                <div style="margin-top: 10px;">
                    <button onclick="analyzeDirectCode()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px;">ì½”ë“œ ë¶„ì„</button>
                    <button onclick="location.reload()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; margin-left: 10px;">íŒŒì¼ ì—…ë¡œë“œë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            `;
        }

        async function analyzeDirectCode() {
            const codeInput = document.getElementById('codeInput');
            if (!codeInput || !codeInput.value.trim()) {
                alert('ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        files: [{
                            name: 'direct_input.cpp',
                            content: codeInput.value,
                            type: 'cpp'
                        }]
                    })
                });

                const result = await response.json();
                if (result.utilities && result.utilities.length > 0) {
                    displayUtilities(result.utilities);
                    document.getElementById('utilitiesSection').style.display = 'block';
                    
                    // ì¦‰ì‹œ ì¶”ì¶œ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
                    addToExtractionHistoryImmediately(result.utilities);
                    
                    // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„œë²„ì—ë„ ì €ì¥
                    autoUploadToExtractionHistory(result.utilities);
                } else {
                    alert('ì¶”ì¶œí•  ìˆ˜ ìˆëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë¶„ì„ ì˜¤ë¥˜:', error);
                alert('ì½”ë“œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function processFiles(files) {
            // ì§„í–‰ë„ í‘œì‹œ UI ìƒì„±
            const uploadSection = document.querySelector('.upload-section');
            const originalHTML = uploadSection.innerHTML;
            
            uploadSection.innerHTML = `
                <h3>ğŸ”„ íŒŒì¼ ë¶„ì„ ì¤‘...</h3>
                <div style="background: #f0f0f0; border-radius: 10px; padding: 3px; margin: 20px 0;">
                    <div id="progressBar" style="background: #007bff; height: 20px; border-radius: 8px; width: 0%; transition: width 0.3s;"></div>
                </div>
                <p id="progressText">ë¶„ì„ ì¤€ë¹„ ì¤‘...</p>
            `;
            
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            // ì§„í–‰ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateProgress(percent, text) {
                progressBar.style.width = percent + '%';
                progressText.textContent = text;
            }
            
            const formData = new FormData();
            files.forEach(file => formData.append('files', file));
            
            try {
                updateProgress(10, 'íŒŒì¼ ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...');
                await new Promise(resolve => setTimeout(resolve, 100));
                
                updateProgress(25, 'ì„œë²„ë¡œ íŒŒì¼ ì „ì†¡ ì¤‘...');
                
                // 0.5ì´ˆ í›„ AI ë¶„ì„ìœ¼ë¡œ ë°”ë¡œ ì „í™˜
                setTimeout(() => {
                    updateProgress(60, 'AI ì½”ë“œ ë¶„ì„ ì¤‘...');
                }, 500);
                
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                updateProgress(70, 'Claude 3.7 ë¶„ì„ ì¤‘...');
                
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }
                
                updateProgress(85, 'ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬ ì¤‘...');
                
                const result = await response.json();
                
                if (result.error) {
                    alert(`ì˜¤ë¥˜: ${result.error}`);
                    return;
                }
                
                updateProgress(95, 'ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì¶”ì¶œ ì™„ë£Œ');
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(100, `ë¶„ì„ ì™„ë£Œ! ${result.utilities.length}ê°œ í•¨ìˆ˜ ë°œê²¬`);
                
                setTimeout(() => {
                    displayUtilities(result.utilities);
                    document.getElementById('utilitiesSection').style.display = 'block';
                    
                    // ì¦‰ì‹œ ì¶”ì¶œ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
                    addToExtractionHistoryImmediately(result.utilities);
                    
                    // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„œë²„ì—ë„ ì €ì¥
                    autoUploadToExtractionHistory(result.utilities);
                }, 500);
                
            } catch (error) {
                console.error('ë¶„ì„ ì˜¤ë¥˜:', error);
                alert(`íŒŒì¼ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            } finally {
                // 2ì´ˆ í›„ ì›ë˜ UIë¡œ ë³µì›
                setTimeout(() => {
                    uploadSection.innerHTML = originalHTML;
                }, 2000);
            }
        }

        function addToExtractionHistoryImmediately(utilities) {
            console.log('=== ì¦‰ì‹œ ì¶”ì¶œ íˆìŠ¤í† ë¦¬ ì¶”ê°€ ì‹œì‘ ===');
            console.log('ì¶”ê°€í•  í•¨ìˆ˜ ê°œìˆ˜:', utilities.length);
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì¦‰ì‹œ ì¶”ê°€
            const existingHistory = JSON.parse(localStorage.getItem('extractionHistory') || '[]');
            console.log('ê¸°ì¡´ íˆìŠ¤í† ë¦¬ ê°œìˆ˜:', existingHistory.length);
            
            utilities.forEach((utility, index) => {
                console.log(`í•¨ìˆ˜ ${index + 1} ì²˜ë¦¬ ì¤‘:`, utility.name);
                
                const historyItem = {
                    id: Date.now() + Math.random(),
                    name: utility.name,
                    description: utility.description,
                    code: utility.code,
                    file: utility.file || 'direct_input.cpp',
                    timestamp: new Date().toISOString(),
                    extracted_at: new Date().toLocaleString('ko-KR', {
                        timeZone: 'Asia/Seoul',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    })
                };
                
                console.log('ìƒì„±ëœ íˆìŠ¤í† ë¦¬ ì•„ì´í…œ:', historyItem);
                existingHistory.unshift(historyItem); // ìµœì‹  í•­ëª©ì„ ë§¨ ì•ì— ì¶”ê°€
            });
            
            localStorage.setItem('extractionHistory', JSON.stringify(existingHistory));
            console.log('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì™„ë£Œ. ì´ ê°œìˆ˜:', existingHistory.length);
            
            // ì¶”ì¶œ íˆìŠ¤í† ë¦¬ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨
            const historyTab = document.getElementById('extraction-history');
            const isHistoryTabActive = historyTab && historyTab.classList.contains('active');
            console.log('íˆìŠ¤í† ë¦¬ íƒ­ í™œì„±í™” ìƒíƒœ:', isHistoryTabActive);
            
            if (isHistoryTabActive) {
                console.log('íˆìŠ¤í† ë¦¬ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆì–´ì„œ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨');
                loadExtractionHistory();
            } else {
                console.log('íˆìŠ¤í† ë¦¬ íƒ­ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŒ');
            }
            
            console.log('=== ì¦‰ì‹œ ì¶”ì¶œ íˆìŠ¤í† ë¦¬ ì¶”ê°€ ì™„ë£Œ ===');
        }

        async function autoUploadToExtractionHistory(utilities) {
            try {
                console.log('=== ìë™ ì¶”ì¶œ íˆìŠ¤í† ë¦¬ ì—…ë¡œë“œ ì‹œì‘ ===');
                console.log('ì—…ë¡œë“œí•  í•¨ìˆ˜ ê°œìˆ˜:', utilities.length);
                
                for (const utility of utilities) {
                    console.log('ì—…ë¡œë“œ ì¤‘ì¸ í•¨ìˆ˜:', utility.name);
                    
                    const functionData = {
                        name: utility.name,
                        description: utility.description,
                        code: utility.code,
                        file: utility.file || 'direct_input.cpp',
                        timestamp: new Date().toISOString(),
                        extracted_at: new Date().toLocaleString('ko-KR', {
                            timeZone: 'Asia/Seoul',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        })
                    };
                    
                    console.log('ì „ì†¡í•  ë°ì´í„°:', functionData);
                    
                    const response = await fetch('/save_extraction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(functionData)
                    });
                    
                    console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                    const result = await response.json();
                    console.log('ì‘ë‹µ ê²°ê³¼:', result);
                    
                    if (!response.ok) {
                        console.error('ì¶”ì¶œ íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:', utility.name, result);
                    } else {
                        console.log('ì €ì¥ ì„±ê³µ:', utility.name);
                    }
                }
                
                console.log('=== ì¶”ì¶œ íˆìŠ¤í† ë¦¬ ìë™ ì—…ë¡œë“œ ì™„ë£Œ ===');
            } catch (error) {
                console.error('=== ì¶”ì¶œ íˆìŠ¤í† ë¦¬ ìë™ ì—…ë¡œë“œ ì˜¤ë¥˜ ===', error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function displayUtilities(utilities) {
            const container = document.getElementById('utilitiesList');
            container.innerHTML = '';
            
            if (utilities.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 8px;">
                        <h4>ì¶”ì¶œí•  ìœ í‹¸ë¦¬í‹°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                        <p>ì—…ë¡œë“œí•œ íŒŒì¼ì—ì„œ í•¨ìˆ˜ë‚˜ êµ¬ì¡°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p>C/C++ íŒŒì¼(.cpp, .c, .h)ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }
            
            utilities.forEach((utility, index) => {
                const div = document.createElement('div');
                div.className = 'utility-item';
                div.innerHTML = `
                    <div class="utility-header" onclick="toggleDetails(${index})">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" onchange="toggleUtility(${index}, this.checked)" onclick="event.stopPropagation()">
                            <div>
                                <strong>${utility.name}</strong>
                                <div style="font-size: 12px; color: #666;">${utility.file} - Line ${utility.line || 'N/A'} - ${utility.type}</div>
                            </div>
                        </div>
                        <div>
                            <span style="font-size: 12px; color: #888;">${utility.description}</span>
                            <span style="margin-left: 10px;">â–¼</span>
                        </div>
                    </div>
                    <div id="details-${index}" class="utility-details">
                        ${utility.role ? `<div class="utility-role"><strong>ì—­í• :</strong> ${utility.role}</div>` : ''}
                        <div class="utility-source">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>ì†ŒìŠ¤ ì½”ë“œ:</strong>
                                <button class="copy-btn" onclick="copyToClipboard('source-${index}')">ë³µì‚¬</button>
                            </div>
                            <pre id="source-${index}" style="margin: 0; font-size: 12px; overflow-x: auto; background: #f8f9fa; padding: 15px; border-radius: 4px;"><code>${escapeHtml(utility.code || 'ì†ŒìŠ¤ ì½”ë“œ ì—†ìŒ')}</code></pre>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleDetails(index) {
            const detailsDiv = document.getElementById(`details-${index}`);
            const isVisible = detailsDiv.style.display !== 'none';
            detailsDiv.style.display = isVisible ? 'none' : 'block';
            
            const header = detailsDiv.previousElementSibling;
            const arrow = header.querySelector('span:last-child');
            arrow.textContent = isVisible ? 'â–¼' : 'â–²';
        }

        function toggleUtility(index, checked) {
            if (checked) {
                selectedUtilities.add(index);
            } else {
                selectedUtilities.delete(index);
            }
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('ì†ŒìŠ¤ ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch(err => {
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('ì†ŒìŠ¤ ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
                }
            } catch (err) {
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
            }
            
            document.body.removeChild(textArea);
        }

        async function startBuild() {
            if (selectedUtilities.size === 0) {
                alert('ë¹Œë“œí•  ìœ í‹¸ë¦¬í‹°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì„ íƒëœ ìœ í‹¸ë¦¬í‹°ì˜ ì‹¤ì œ ë°ì´í„° ìˆ˜ì§‘
            const selectedUtilityData = [];
            const allUtilities = document.querySelectorAll('.utility-item');
            
            allUtilities.forEach((item, index) => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    const nameElement = item.querySelector('strong');
                    const codeElement = item.querySelector('pre code');
                    const descElement = item.querySelector('.utility-header span');
                    
                    selectedUtilityData.push({
                        name: nameElement ? nameElement.textContent : `Function_${index}`,
                        description: descElement ? descElement.textContent : 'í•¨ìˆ˜',
                        code: codeElement ? codeElement.textContent : '// ì½”ë“œ ì—†ìŒ'
                    });
                }
            });

            const config = {
                architecture: document.getElementById('architecture').value,
                runtime: document.getElementById('runtime').value,
                msvc_version: document.getElementById('msvcVersion').value,
                library_type: document.getElementById('libraryType').value,
                utilities: selectedUtilityData,  // ì‹¤ì œ í•¨ìˆ˜ ë°ì´í„°
                comment: ''
            };

            document.getElementById('progressSection').style.display = 'block';
            
            // ì§„í–‰ë¥  ì‹œë®¬ë ˆì´ì…˜
            simulateProgress();

            try {
                const response = await fetch('/build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                currentBuildId = result.build_id;
                
                // ë¼ì´ë¸ŒëŸ¬ë¦¬ íƒ€ì…ì— ë”°ë¥¸ UI ì—…ë°ì´íŠ¸
                const libraryType = config.library_type;
                const downloadBtn = document.getElementById('downloadLibBtn');
                const resultMessage = document.getElementById('buildResultMessage');
                
                if (libraryType === 'dll') {
                    downloadBtn.textContent = 'DLL ë‹¤ìš´ë¡œë“œ';
                    resultMessage.textContent = 'DLL íŒŒì¼ê³¼ ê°€ì´ë“œ ë¬¸ì„œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.';
                } else {
                    downloadBtn.textContent = 'LIB ë‹¤ìš´ë¡œë“œ';
                    resultMessage.textContent = 'LIB íŒŒì¼ê³¼ ê°€ì´ë“œ ë¬¸ì„œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.';
                }
                
                setTimeout(() => {
                    document.getElementById('buildResult').style.display = 'block';
                }, 3000);
                
            } catch (error) {
                alert('ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function simulateProgress() {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            let progress = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                progressFill.style.width = progress + '%';
                
                if (progress < 30) {
                    progressText.textContent = 'ì½”ë“œ ë¶„ì„ ì¤‘...';
                } else if (progress < 60) {
                    progressText.textContent = 'DLL ì»´íŒŒì¼ ì¤‘...';
                } else if (progress < 90) {
                    progressText.textContent = 'ë¬¸ì„œ ìƒì„± ì¤‘...';
                } else if (progress >= 100) {
                    progressText.textContent = 'ë¹Œë“œ ì™„ë£Œ!';
                    clearInterval(interval);
                }
            }, 200);
        }

        function downloadLibrary() {
            if (currentBuildId) {
                window.open(`/download/${currentBuildId}`, '_blank');
            }
        }

        function downloadLibrary() {
            if (currentBuildId) {
                window.open(`/download/${currentBuildId}`, '_blank');
            }
        }

        function downloadHeader() {
            if (currentBuildId) {
                window.open(`/download/${currentBuildId}/header`, '_blank');
            }
        }

        function downloadDll() {
            downloadLibrary();
        }

        // ë¹Œë“œ íˆìŠ¤í† ë¦¬ìš© ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ë“¤
        function downloadDLLFromHistory(buildId) {
            window.open(`/download/${buildId}`, '_blank');
        }

        function downloadHeaderFromHistory(buildId) {
            window.open(`/download/${buildId}/header`, '_blank');
        }

        async function generateDocsFromHistory(buildId) {
            const button = event.target;
            const buttonContainer = button.parentElement;
            
            // ê¸°ì¡´ ì§„í–‰ë¥  ì œê±° (ìˆë‹¤ë©´)
            const existingProgress = buttonContainer.querySelector('.doc-progress');
            if (existingProgress) {
                existingProgress.remove();
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            button.disabled = true;
            button.textContent = 'ìƒì„±ì¤‘...';
            
            // ì§„í–‰ë¥  ê²Œì´ì§€ ìƒì„± (ë²„íŠ¼ ë°‘ì—)
            const progressHtml = `
                <div class="doc-progress" style="margin-top: 5px; width: 100%;">
                    <div style="background: #f0f0f0; border-radius: 10px; padding: 2px; margin: 5px 0;">
                        <div id="docProgressBar-${buildId}" style="background: #007bff; height: 8px; border-radius: 8px; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="docProgressText-${buildId}" style="font-size: 10px; color: #666; text-align: center;">AIê°€ ë¬¸ì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                </div>
            `;
            
            buttonContainer.insertAdjacentHTML('beforeend', progressHtml);
            
            const progressBar = document.getElementById(`docProgressBar-${buildId}`);
            const progressText = document.getElementById(`docProgressText-${buildId}`);
            
            try {
                // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜
                progressBar.style.width = '30%';
                progressText.textContent = 'í•¨ìˆ˜ ì •ë³´ ë¶„ì„ ì¤‘...';
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                progressBar.style.width = '60%';
                progressText.textContent = 'AI ë¬¸ì„œ ìƒì„± ì¤‘...';
                
                const response = await fetch(`/generate_docs/${buildId}`);
                const result = await response.json();
                
                progressBar.style.width = '90%';
                progressText.textContent = 'ë¬¸ì„œ ì—…ë¡œë“œ ì¤‘...';
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                if (result.success) {
                    progressBar.style.width = '100%';
                    progressBar.style.background = '#28a745';
                    progressText.textContent = 'ë¬¸ì„œ ìƒì„± ì™„ë£Œ!';
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ
                    if (result.doc_url) {
                        const link = document.createElement('a');
                        link.href = result.doc_url;
                        link.download = `${buildId}_docs.md`;
                        link.target = '_blank';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        window.open(`/download/${buildId}/docs`, '_blank');
                    }
                    
                    // 2ì´ˆ í›„ ì§„í–‰ë¥  ì œê±°
                    setTimeout(() => {
                        const progress = buttonContainer.querySelector('.doc-progress');
                        if (progress) progress.remove();
                        button.disabled = false;
                        button.textContent = 'ë¬¸ì„œ';
                    }, 2000);
                    
                } else {
                    progressBar.style.background = '#dc3545';
                    progressText.textContent = 'ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    
                    setTimeout(() => {
                        const progress = buttonContainer.querySelector('.doc-progress');
                        if (progress) progress.remove();
                        button.disabled = false;
                        button.textContent = 'ë¬¸ì„œ';
                    }, 3000);
                }
            } catch (error) {
                console.error('ë¬¸ì„œ ìƒì„± ì˜¤ë¥˜:', error);
                
                progressBar.style.background = '#dc3545';
                progressText.textContent = 'ë¬¸ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ';
                
                setTimeout(() => {
                    const progress = buttonContainer.querySelector('.doc-progress');
                    if (progress) progress.remove();
                    button.disabled = false;
                    button.textContent = 'ë¬¸ì„œ';
                }, 3000);
            }
        }

        async function generateDocs() {
            if (!currentBuildId) {
                alert('ë¹Œë“œ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const docsBtn = document.getElementById('docsBtn');
            const docsProgress = document.getElementById('docsProgress');
            const progressBar = document.getElementById('docsProgressBar');
            const progressText = document.getElementById('docsProgressText');
            
            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì§„í–‰ë¥  í‘œì‹œ
            docsBtn.disabled = true;
            docsBtn.textContent = 'ìƒì„± ì¤‘...';
            docsProgress.style.display = 'block';
            
            // ì§„í–‰ë¥  ì‹œë®¬ë ˆì´ì…˜ (ë” ëŠë¦¬ê²Œ)
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 5 + 2;  // 2~7ì”© ì¦ê°€ (ë” ëŠë¦¬ê²Œ)
                if (progress > 90) progress = 90;
                
                progressBar.style.width = progress + '%';
                progressText.textContent = `ë¬¸ì„œ ìƒì„± ì¤‘... ${Math.round(progress)}%`;
            }, 500);  // 500msë§ˆë‹¤ ì—…ë°ì´íŠ¸ (ë” ëŠë¦¬ê²Œ)
            
            try {
                // ë¬¸ì„œ ìƒì„± ìš”ì²­
                const response = await fetch(`/docs/${currentBuildId}`);
                
                if (response.ok) {
                    // ì™„ë£Œ ì²˜ë¦¬
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    progressText.textContent = 'ë¬¸ì„œ ìƒì„± ì™„ë£Œ! ë‹¤ìš´ë¡œë“œ ì¤‘...';
                    
                    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${currentBuildId}_documentation.md`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // UI ë³µì›
                    setTimeout(() => {
                        docsProgress.style.display = 'none';
                        docsBtn.disabled = false;
                        docsBtn.textContent = 'ê°€ì´ë“œ ë¬¸ì„œ';
                        progressBar.style.width = '0%';
                    }, 1000);
                } else {
                    throw new Error('ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨');
                }
            } catch (error) {
                clearInterval(progressInterval);
                alert('ë¬¸ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                
                // UI ë³µì›
                docsProgress.style.display = 'none';
                docsBtn.disabled = false;
                docsBtn.textContent = 'ê°€ì´ë“œ ë¬¸ì„œ';
                progressBar.style.width = '0%';
            }
        }

        function downloadDocs() {
            generateDocs();
        }

        async function loadHistory() {
            try {
                const response = await fetch('/get_history');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayHistory(result.history || []);
                } else {
                    document.getElementById('historyList').innerHTML = 'íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                }
            } catch (error) {
                console.error('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('historyList').innerHTML = 'íˆìŠ¤í† ë¦¬ ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ' + error.message;
            }
        }
        
        function displayHistory(historyItems) {
            const container = document.getElementById('historyList');
            
            // ì•ˆì „ì„± ê²€ì‚¬ ì¶”ê°€
            if (!historyItems || !Array.isArray(historyItems) || historyItems.length === 0) {
                container.innerHTML = '<p>ë¹Œë“œ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            container.innerHTML = '';
            
            historyItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'utility-item';
                div.innerHTML = `
                    <div class="utility-header" onclick="toggleHistoryDetails(${index})">
                        <div>
                            <strong>${item.comment || 'ì½”ë©˜íŠ¸ ì—†ìŒ'}</strong>
                            <div style="font-size: 12px; color: #666;">
                                ${item.timestamp ? new Date(item.timestamp).toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'}) : 'ì‹œê°„ ì •ë³´ ì—†ìŒ'} - ${item.utility_count || 0}ê°œ í•¨ìˆ˜
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button onclick="event.stopPropagation(); downloadDLLFromHistory('${item.build_id}')" 
                                    style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 11px;">
                                DLL
                            </button>
                            <button onclick="event.stopPropagation(); downloadHeaderFromHistory('${item.build_id}')" 
                                    style="padding: 4px 8px; background: #17a2b8; color: white; border: none; border-radius: 4px; font-size: 11px;">
                                í—¤ë”
                            </button>
                            <button onclick="event.stopPropagation(); generateDocsFromHistory('${item.build_id}')" 
                                    style="padding: 4px 8px; background: #ffc107; color: black; border: none; border-radius: 4px; font-size: 11px;">
                                ë¬¸ì„œ
                            </button>
                            <span style="margin-left: 10px;">â–¼</span>
                        </div>
                    </div>
                    <div id="history-details-${index}" class="utility-details" style="display: none;">
                        <div id="history-utilities-${index}"></div>
                    </div>
                `;
                container.appendChild(div);
                
                // ìœ í‹¸ë¦¬í‹° ëª©ë¡ í‘œì‹œ
                const utilitiesContainer = document.getElementById(`history-utilities-${index}`);
                const utilities = item.utilities || [];
                
                if (utilities.length === 0) {
                    utilitiesContainer.innerHTML = '<p>í•¨ìˆ˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                utilities.forEach((utility, utilIndex) => {
                    const utilDiv = document.createElement('div');
                    utilDiv.innerHTML = `
                        <div style="margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                            <div onclick="toggleHistoryUtilityCode(${index}, ${utilIndex})" style="cursor: pointer;">
                                <strong>${utility.name || 'Unknown'}</strong> - ${utility.description || 'ì„¤ëª… ì—†ìŒ'}
                                <span style="margin-left: 10px;">â–¼</span>
                            </div>
                            <div id="history-code-${index}-${utilIndex}" style="display: none; margin-top: 10px;">
                                <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px; overflow-x: auto;"><code>${escapeHtml(utility.code || '// ì½”ë“œ ì—†ìŒ')}</code></pre>
                            </div>
                        </div>
                    `;
                    utilitiesContainer.appendChild(utilDiv);
                });
            });
        }
        
        function toggleHistoryDetails(index) {
            const detailsDiv = document.getElementById(`history-details-${index}`);
            const isVisible = detailsDiv.style.display !== 'none';
            detailsDiv.style.display = isVisible ? 'none' : 'block';
            
            const header = detailsDiv.previousElementSibling;
            const arrow = header.querySelector('span:last-child');
            arrow.textContent = isVisible ? 'â–¼' : 'â–²';
        }
        
        function toggleHistoryUtilityCode(historyIndex, utilityIndex) {
            const codeDiv = document.getElementById(`history-code-${historyIndex}-${utilityIndex}`);
            const isVisible = codeDiv.style.display !== 'none';
            codeDiv.style.display = isVisible ? 'none' : 'block';
            
            const header = codeDiv.previousElementSibling;
            const arrow = header.querySelector('span:last-child');
            arrow.textContent = isVisible ? 'â–¼' : 'â–²';
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ íˆìŠ¤í† ë¦¬ ìë™ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
        });

        async function uploadToHistory() {
            const comment = document.getElementById('buildComment').value;
            if (!comment.trim()) {
                alert('ë¹Œë“œ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!currentBuildId) {
                alert('ë¹Œë“œ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì„ íƒëœ ìœ í‹¸ë¦¬í‹° ì •ë³´ ìˆ˜ì§‘
            const selectedUtilityData = [];
            const allUtilities = document.querySelectorAll('.utility-item');
            
            allUtilities.forEach((item, index) => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    const nameElement = item.querySelector('strong');
                    const codeElement = item.querySelector('pre code');
                    const descElement = item.querySelector('.utility-header span');
                    
                    selectedUtilityData.push({
                        name: nameElement ? nameElement.textContent : `Function_${index}`,
                        description: descElement ? descElement.textContent : 'í•¨ìˆ˜',
                        code: codeElement ? codeElement.textContent : '// ì½”ë“œ ì—†ìŒ'
                    });
                }
            });
            
            try {
                const response = await fetch('/upload_to_history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        build_id: currentBuildId,
                        comment: comment,
                        selected_utilities: selectedUtilityData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    document.getElementById('buildResult').style.display = 'none';
                    document.getElementById('progressSection').style.display = 'none';
                    document.getElementById('buildComment').value = '';
                } else {
                    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
                
            } catch (error) {
                alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì¶”ì¶œ íˆìŠ¤í† ë¦¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        let selectedFunctions = [];

        async function loadExtractionHistory() {
            try {
                console.log('=== ì¶”ì¶œ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹œì‘ ===');
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const localHistory = JSON.parse(localStorage.getItem('extractionHistory') || '[]');
                console.log('ë¡œì»¬ íˆìŠ¤í† ë¦¬ ê°œìˆ˜:', localHistory.length);
                
                // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                let serverHistory = [];
                try {
                    const response = await fetch('/extraction_history');
                    const data = await response.json();
                    serverHistory = data.functions || [];
                    console.log('ì„œë²„ íˆìŠ¤í† ë¦¬ ê°œìˆ˜:', serverHistory.length);
                } catch (error) {
                    console.error('ì„œë²„ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
                
                // ë¡œì»¬ê³¼ ì„œë²„ ë°ì´í„° í•©ì¹˜ê¸° (ì¤‘ë³µ ì œê±°)
                const allHistory = [...localHistory];
                serverHistory.forEach(serverItem => {
                    const exists = localHistory.some(localItem => 
                        localItem.name === serverItem.name && 
                        localItem.code === serverItem.code
                    );
                    if (!exists) {
                        allHistory.push(serverItem);
                    }
                });
                
                // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹  ìˆœ)
                allHistory.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
                
                console.log('ì „ì²´ íˆìŠ¤í† ë¦¬ ê°œìˆ˜:', allHistory.length);
                displayExtractionHistory(allHistory);
                
            } catch (error) {
                console.error('ì¶”ì¶œ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('extractionHistoryList').innerHTML = '<p>íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        async function searchFunctions() {
            const searchTerm = document.getElementById('searchInput').value;
            try {
                const response = await fetch('/search_functions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ search_term: searchTerm })
                });
                const data = await response.json();
                displayExtractionHistory(data.functions || []);
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            }
        }

        function displayExtractionHistory(functions) {
            const container = document.getElementById('extractionHistoryList');
            
            if (!functions || functions.length === 0) {
                container.innerHTML = '<p>ì¶”ì¶œëœ í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            functions.forEach(func => {
                html += `
                    <div class="function-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <input type="checkbox" id="func_${func.id}" onchange="toggleFunctionSelection('${func.id}', this.checked)">
                                <label for="func_${func.id}" style="font-weight: bold; font-size: 16px; margin-left: 8px;">${func.name || 'í•¨ìˆ˜ëª… ì—†ìŒ'}</label>
                            </div>
                            <small style="color: #666;">${func.timestamp ? new Date(func.timestamp).toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'}) : ''}</small>
                        </div>
                        <p style="color: #666; margin: 5px 0;"><strong>ì„¤ëª…:</strong> ${func.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">ì½”ë“œ ë³´ê¸°</summary>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; margin-top: 10px;"><code>${func.code || '// ì½”ë“œ ì—†ìŒ'}</code></pre>
                        </details>
                        <small style="color: #999;">ë¹Œë“œ ID: ${func.build_id || 'N/A'} | ${func.comment || 'ì½”ë©˜íŠ¸ ì—†ìŒ'}</small>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function toggleFunctionSelection(functionId, isSelected) {
            if (isSelected) {
                selectedFunctions.push(functionId);
            } else {
                selectedFunctions = selectedFunctions.filter(id => id !== functionId);
            }
            
            // ì‚¬ìš© ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            const useBtn = document.getElementById('useSelectedBtn');
            useBtn.disabled = selectedFunctions.length === 0;
        }

        async function useSelectedFunctions() {
            if (selectedFunctions.length === 0) {
                alert('ì‚¬ìš©í•  í•¨ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // ì„ íƒëœ í•¨ìˆ˜ë“¤ì˜ ë°ì´í„° ìˆ˜ì§‘
                const response = await fetch('/extraction_history');
                const data = await response.json();
                const allFunctions = data.functions || [];
                
                const selectedUtilityData = [];
                
                for (const funcId of selectedFunctions) {
                    const func = allFunctions.find(f => f.id === funcId);
                    if (func) {
                        selectedUtilityData.push({
                            name: func.name,
                            description: func.description,
                            purpose: func.purpose,
                            code: func.code,
                            parameters: func.parameters,
                            return_type: func.return_type,
                            header_declaration: func.header_declaration,
                            required_headers: func.required_headers || [],
                            reusability_score: 10, // ì´ë¯¸ ì¶”ì¶œëœ í•¨ìˆ˜ì´ë¯€ë¡œ ë†’ì€ ì ìˆ˜
                            changes_made: 'ì¶”ì¶œ íˆìŠ¤í† ë¦¬ì—ì„œ ê°€ì ¸ì˜´',
                            line: 1,
                            file: 'ì¶”ì¶œ íˆìŠ¤í† ë¦¬',
                            type: 'function'
                        });
                    }
                }
                
                // ìœ í‹¸ë¦¬í‹° ì¶”ì¶œ íƒ­ìœ¼ë¡œ ì´ë™
                showTab('extract');
                
                // ê¸°ì¡´ ìœ í‹¸ë¦¬í‹°ì— ì¶”ê°€ (ë®ì–´ì“°ì§€ ì•Šê³  append)
                appendUtilities(selectedUtilityData);
                document.getElementById('utilitiesSection').style.display = 'block';
                
                alert(`${selectedFunctions.length}ê°œ í•¨ìˆ˜ê°€ ìœ í‹¸ë¦¬í‹° ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                // ì„ íƒ ì´ˆê¸°í™”
                selectedFunctions = [];
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                document.getElementById('useSelectedBtn').disabled = true;
                
            } catch (error) {
                console.error('í•¨ìˆ˜ ì‚¬ìš© ì˜¤ë¥˜:', error);
                alert('í•¨ìˆ˜ë¥¼ ì¶”ê°€í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function appendUtilities(newUtilities) {
            const container = document.getElementById('utilitiesList');
            
            newUtilities.forEach((utility, index) => {
                const div = document.createElement('div');
                div.className = 'utility-item';
                
                // ê¸°ì¡´ ìœ í‹¸ë¦¬í‹° ê°œìˆ˜ë¥¼ ê³ ë ¤í•œ ì¸ë±ìŠ¤ ê³„ì‚°
                const existingCount = container.children.length;
                const actualIndex = existingCount + index;
                
                div.innerHTML = `
                    <div class="utility-header" onclick="toggleDetails(${actualIndex})">
                        <div>
                            <input type="checkbox" id="utility-${actualIndex}" onchange="toggleUtility(${actualIndex}, this.checked)">
                            <label for="utility-${actualIndex}">
                                <strong>${utility.name}</strong>
                                <div style="font-size: 12px; color: #666;">${utility.file} - Line ${utility.line || 'N/A'} - ${utility.type}</div>
                            </label>
                        </div>
                        <div>
                            <span style="font-size: 12px; color: #888;">${utility.description}</span>
                            <span style="margin-left: 10px;">â–¼</span>
                        </div>
                    </div>
                    <div id="details-${actualIndex}" class="utility-details">
                        ${utility.role ? `<div class="utility-role"><strong>ì—­í• :</strong> ${utility.role}</div>` : ''}
                        <div class="utility-source">
                            <strong>ëª©ì :</strong> ${utility.purpose || 'ëª©ì  ì •ë³´ ì—†ìŒ'}<br>
                            <strong>ë§¤ê°œë³€ìˆ˜:</strong> ${utility.parameters || 'ë§¤ê°œë³€ìˆ˜ ì—†ìŒ'}<br>
                            <strong>ë°˜í™˜íƒ€ì…:</strong> ${utility.return_type || 'ë°˜í™˜íƒ€ì… ì—†ìŒ'}
                        </div>
                        <div class="utility-code">
                            <strong>ì½”ë“œ:</strong>
                            <pre><code>${escapeHtml(utility.code)}</code></pre>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        // íƒ­ ì „í™˜ ì‹œ ì¶”ì¶œ íˆìŠ¤í† ë¦¬ ë¡œë“œ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // í´ë¦­ëœ íƒ­ í™œì„±í™” (eventê°€ ìˆì„ ë•Œë§Œ)
            if (window.event && window.event.target) {
                window.event.target.classList.add('active');
            } else {
                // eventê°€ ì—†ìœ¼ë©´ íƒ­ ì´ë¦„ìœ¼ë¡œ ì°¾ì•„ì„œ í™œì„±í™”
                document.querySelector(`button[onclick="showTab('${tabName}')"]`).classList.add('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            
            // ì¶”ì¶œ íˆìŠ¤í† ë¦¬ íƒ­ì´ ì„ íƒë˜ë©´ ë°ì´í„° ë¡œë“œ
            if (tabName === 'extraction-history') {
                loadExtractionHistory();
            }
            
            // ë¹Œë“œ íˆìŠ¤í† ë¦¬ íƒ­ì´ ì„ íƒë˜ë©´ ë°ì´í„° ë¡œë“œ
            if (tabName === 'history') {
                loadHistory();
            }
        }
    </script>
</body>
</html>
